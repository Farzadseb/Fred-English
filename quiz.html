<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quiz - Fred English</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg:#f2f2f7; --txt:#1c1c1e; --crd:#fff; --blu:#007aff; --grn:#34c759; --red:#ff3b30; --st:env(safe-area-inset-top); }
        body.dark-mode { --bg:#0b1426; --txt:#fff; --crd:rgba(255,255,255,0.12); }
        body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); color:var(--txt); margin:0; padding:calc(var(--st) + 10px) 15px 20px; display:flex; flex-direction:column; align-items:center; min-height:100dvh; transition:0.2s; }
        .app { width:100%; max-width:400px; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .card { background:var(--crd); padding:20px; border-radius:24px; box-shadow:0 4px 15px rgba(0,0,0,0.05); text-align:center; margin-bottom:15px; border:1px solid rgba(0,0,0,0.05); }
        .q-word { font-size:32px; font-weight:800; color:var(--blu); margin-bottom:5px; direction: ltr; text-align: left; }
        .q-def { font-size:15px; color:#666; margin-bottom:20px; line-height:1.4; text-align: right; direction: rtl; }
        .opt { width:100%; padding:16px; margin-bottom:10px; border-radius:16px; border:2px solid rgba(0,0,0,0.05); background:var(--crd); color:var(--txt); font-size:16px; font-weight:600; cursor:pointer; transition:0.1s; text-align:right; display:flex; justify-content:space-between; align-items:center; }
        .opt:active { transform:scale(0.98); }
        .opt.correct { border-color:var(--grn); background:rgba(52,199,89,0.1); }
        .opt.wrong { border-color:var(--red); background:rgba(255,59,48,0.1); }
        .details { display:none; text-align:right; margin-top:15px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .info-box { background:rgba(0,122,255,0.05); padding:15px; border-radius:15px; margin-top:10px; border-right:4px solid var(--blu); }
        .btn-next { width:100%; padding:16px; border-radius:18px; background:var(--blu); color:#fff; border:none; font-size:17px; font-weight:bold; cursor:pointer; margin-top:10px; display:none; }
        .prog-container { width:100%; height:6px; background:rgba(0,0,0,0.05); border-radius:3px; margin-bottom:20px; overflow:hidden; }
        .prog-bar { height:100%; background:var(--blu); width:0%; transition:0.3s; }
        
        /* Ø¯Ú©Ù…Ù‡ Ø§Ø³Ù¾ÛŒÚ©Ø± */
        .speak-btn { background:rgba(0,122,255,0.1); border:none; font-size:18px; color:#007aff; cursor:pointer; padding:8px 12px; border-radius:10px; margin-left:10px; }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div onclick="goBack()" style="cursor:pointer; font-size:18px;"><i class="fas fa-chevron-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª</div>
            <div id="q-counter" style="font-weight:bold;">1 / 10</div>
            <div id="score-live">Ø§Ù…ØªÛŒØ§Ø²: 0</div>
        </div>

        <div class="prog-container"><div id="p-bar" class="prog-bar"></div></div>

        <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div id="q-word" class="q-word">Word</div>
                <button class="speak-btn" onclick="speakQuestion()">ğŸ”Š</button>
            </div>
            <div id="q-def" class="q-def">Definition of the word goes here...</div>
            <div id="options-container"></div>
            
            <div id="details" class="details">
                <div class="info-box">
                    <b style="color:var(--blu)"><i class="fas fa-quote-left"></i> Ù…Ø«Ø§Ù„ Ø§ØµÙ„ÛŒ:</b>
                    <div id="d-ex" style="margin:5px 0; direction: ltr; text-align: left;">Example sentence...</div>
                    <small id="d-ex-fa" style="color:#666; direction: rtl; text-align: right;">ØªØ±Ø¬Ù…Ù‡ Ù…Ø«Ø§Ù„...</small>
                </div>
                
                <div class="info-box" style="border-color:var(--grn); background:rgba(52,199,89,0.05)">
                    <b style="color:var(--grn)"><i class="fas fa-link"></i> Ú©Ø§Ù„ÙˆÚ©ÛŒØ´Ù†:</b>
                    <div id="d-coll" style="direction: ltr; text-align: left;">Collocation</div>
                    <small id="d-coll-ex" style="color:#666; direction: rtl; text-align: right;">Example: ...</small>
                </div>

                <div class="info-box" style="border-color:#ff9500; background:rgba(255,149,0,0.05)">
                    <b style="color:#ff9500"><i class="fas fa-rocket"></i> ÙØ¹Ù„ Ø¹Ø¨Ø§Ø±ØªÛŒ (Phrasal):</b>
                    <div id="d-ph" style="direction: ltr; text-align: left;">Phrasal Verb</div>
                    <small id="d-ph-ex" style="color:#666; direction: rtl; text-align: right;">Example: ...</small>
                </div>
            </div>
        </div>

        <button id="btn-next" class="btn-next" onclick="nextQuestion()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ <i class="fas fa-arrow-left"></i></button>
    </div>

    <audio id="snd-correct" src="https://www.soundjay.com/buttons/sounds/button-37.mp3"></audio>
    <audio id="snd-wrong" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>

    <script src="a1-words.js"></script>
    <script>
        // ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§ Base64
        const TELEGRAM_TOKEN_BASE64 = "ODU1MzIyNDUxNDpBQUcwWFh6QThkYTU1akNHeG56U3RQLTBJeEhobmZrVFBSdw==";
        const TELEGRAM_CHAT_ID_BASE64 = "OTY5OTE4NTk=";
        const TELEGRAM_TOKEN = atob(TELEGRAM_TOKEN_BASE64);
        const TELEGRAM_CHAT_ID = atob(TELEGRAM_CHAT_ID_BASE64);
        
        let currentIdx = 0;
        let score = 0;
        let quizWords = [];
        const totalQ = 10;
        const mode = localStorage.getItem('quiz_mode') || 'en-fa';
        
        function sendToTelegram(message) {
            try {
                const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
                const params = { chat_id: TELEGRAM_CHAT_ID, text: message };
                fetch(`${url}?${new URLSearchParams(params)}`).catch(e => console.error(e));
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…:', error);
            }
        }
        
        function goBack() {
            const user = localStorage.getItem('fred_user');
            const progress = Math.round(((currentIdx + 1) / totalQ) * 100);
            
            if (currentIdx > 0 && progress < 50) {
                const messages = [
                    `â¸ï¸ ${user} Ú©ÙˆÛŒÛŒØ² Ø±Ùˆ Ù†ØµÙÙ‡ Ø±Ù‡Ø§ Ú©Ø±Ø¯! Ø§Ù…ØªÛŒØ§Ø²: ${score}`,
                    `ğŸš§ ${user} Ø§Ø² Ú©ÙˆÛŒÛŒØ² Ø®Ø§Ø±Ø¬ Ø´Ø¯! ${currentIdx + 1} Ø³ÙˆØ§Ù„ Ø§Ø² ${totalQ}`,
                    `âš ï¸ ${user} Ú©ÙˆÛŒÛŒØ² Ø±Ùˆ Ú©Ø§Ù…Ù„ Ù†Ú©Ø±Ø¯! Ù¾ÛŒØ´Ø±ÙØª: ${progress}%`
                ];
                
                const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                sendToTelegram(randomMsg);
                
                if (!confirm(`ğŸ¯ ÙÙ‚Ø· ${100 - progress}% Ù…ÙˆÙ†Ø¯Ù‡! ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø¨Ø±ÛŒØŸ\n\nØ§Ù…ØªÛŒØ§Ø²Øª: ${score}`)) {
                    return;
                }
            }
            
            // Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
            if (score > 0) {
                sendToTelegram(`ğŸ“Š ${user || 'Ú©Ø§Ø±Ø¨Ø±'} Ú©ÙˆÛŒÛŒØ² Ø±Ùˆ ØªÙ…ÙˆÙ… Ú©Ø±Ø¯:\nğŸ† Ø§Ù…ØªÛŒØ§Ø²: ${score}\nğŸ¯ Ø­Ø§Ù„Øª: ${mode}\nğŸ“… ${new Date().toLocaleString('fa-IR')}`);
            }
            
            window.location.href = 'index.html';
        }
        
        function init() {
            if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
            
            const user = localStorage.getItem('fred_user');
            sendToTelegram(`ğŸ¯ ${user} Ú©ÙˆÛŒÛŒØ² ${mode} Ø±Ùˆ Ø´Ø±ÙˆØ¹ Ú©Ø±Ø¯\nğŸ“… ${new Date().toLocaleString('fa-IR')}`);
            
            quizWords = [...window.wordsA1].sort(() => 0.5 - Math.random()).slice(0, totalQ);
            render();
        }
        
        function render() {
            const w = quizWords[currentIdx];
            const cont = document.getElementById('options-container');
            
            // ØªÙ†Ø¸ÛŒÙ… Ø³ÙˆØ§Ù„
            if (mode === 'fa-en') {
                document.getElementById('q-word').innerText = 'Ú©Ù„Ù…Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ú†ÛŒØ³ØªØŸ';
                document.getElementById('q-def').innerText = `"${w.translation}"`;
            } else if (mode === 'en-fa') {
                document.getElementById('q-word').innerText = w.word.replace('(A1)', '');
                document.getElementById('q-def').innerText = 'Ù…Ø¹Ù†ÛŒ ÙØ§Ø±Ø³ÛŒ Ú†ÛŒØ³ØªØŸ';
            } else if (mode === 'word-def') {
                document.getElementById('q-word').innerText = w.word.replace('(A1)', '');
                document.getElementById('q-def').innerText = 'ØªØ¹Ø±ÛŒÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ØµØ­ÛŒØ­ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:';
            } else if (mode === 'def-word') {
                document.getElementById('q-word').innerText = 'Ú©Ù„Ù…Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† ØªØ¹Ø±ÛŒÙ Ú†ÛŒØ³ØªØŸ';
                document.getElementById('q-def').innerText = `"${w.definition_en}"`;
            } else {
                document.getElementById('q-word').innerText = w.word.replace('(A1)', '');
                document.getElementById('q-def').innerText = 'Ú¯Ø²ÛŒÙ†Ù‡ ØµØ­ÛŒØ­ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:';
            }
            
            document.getElementById('q-counter').innerText = `${currentIdx + 1} / ${totalQ}`;
            document.getElementById('p-bar').style.width = `${((currentIdx + 1) / totalQ) * 100}%`;
            document.getElementById('details').style.display = 'none';
            document.getElementById('btn-next').style.display = 'none';
            cont.innerHTML = '';
            
            // Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
            let opts = [w];
            while(opts.length < 4) {
                let r = window.wordsA1[Math.floor(Math.random() * window.wordsA1.length)];
                if(!opts.includes(r)) opts.push(r);
            }
            opts.sort(() => 0.5 - Math.random());
            
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'opt';
                
                if(mode === 'fa-en' || mode === 'def-word') btn.innerText = o.word.replace('(A1)', '');
                else if(mode === 'word-def') btn.innerText = o.definition_en;
                else btn.innerText = o.translation;
                
                btn.onclick = () => check(btn, o === w);
                cont.appendChild(btn);
            });
            
            // ØªÙ„ÙØ¸ Ø®ÙˆØ¯Ú©Ø§Ø±
            if(mode !== 'fa-en') {
                setTimeout(() => speakQuestion(), 300);
            }
        }
        
        function speakQuestion() {
            const w = quizWords[currentIdx];
            if (!w) return;
            
            const utterance = new SpeechSynthesisUtterance(w.word.replace('(A1)', ''));
            utterance.lang = 'en-US';
            utterance.rate = 0.5;
            
            const voices = speechSynthesis.getVoices();
            const femaleVoice = voices.find(v => 
                v.lang === 'en-US' && 
                (v.name.includes('Female') || v.name.includes('Woman'))
            );
            if (femaleVoice) utterance.voice = femaleVoice;
            
            window.speechSynthesis.speak(utterance);
        }
        
        function check(el, isCorrect) {
            if(document.getElementById('btn-next').style.display === 'block') return;
            const w = quizWords[currentIdx];
            
            if(isCorrect) {
                el.classList.add('correct');
                el.innerHTML += ' <i class="fas fa-check-circle"></i>';
                score += 10;
                document.getElementById('snd-correct').play();
            } else {
                el.classList.add('wrong');
                el.innerHTML += ' <i class="fas fa-times-circle"></i>';
                document.getElementById('snd-wrong').play();
            }
            
            document.getElementById('score-live').innerText = `Ø§Ù…ØªÛŒØ§Ø²: ${score}`;
            showDetails(w);
        }
        
        function showDetails(w) {
            document.getElementById('d-ex').innerText = w.collocation_example;
            document.getElementById('d-ex-fa').innerText = w.collocation_example_fa;
            document.getElementById('d-coll').innerText = w.collocation;
            document.getElementById('d-coll-ex').innerText = w.collocation_fa;
            document.getElementById('d-ph').innerText = w.pv1;
            document.getElementById('d-ph-ex').innerText = w.pv1_fa;
            
            document.getElementById('details').style.display = 'block';
            document.getElementById('btn-next').style.display = 'block';
        }
        
        function nextQuestion() {
            currentIdx++;
            if(currentIdx < totalQ) render();
            else finish();
        }
        
        function finish() {
            const user = localStorage.getItem('fred_user');
            
            // Ù¾ÛŒØ§Ù… Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø²
            let message = '';
            if (score >= 90) message = `ğŸ† Ø¹Ø§Ù„ÛŒ! ${user} Ù†Ù…Ø±Ù‡ Ú©Ø§Ù…Ù„ Ú¯Ø±ÙØª!`;
            else if (score >= 70) message = `ğŸ¯ Ø®ÙˆØ¨Ù‡! ${user} Ø§Ù…ØªÛŒØ§Ø² ${score} Ú¯Ø±ÙØª`;
            else if (score >= 50) message = `ğŸ‘ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„! ${user} Ø§Ù…ØªÛŒØ§Ø² ${score}`;
            else message = `ğŸ’ª Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡! ${user} Ø§Ù…ØªÛŒØ§Ø² ${score}`;
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
            const telegramMsg = `${message}\nğŸ“Š Ø­Ø§Ù„Øª: ${mode}\nğŸ¯ Ø§Ù…ØªÛŒØ§Ø²: ${score}/100\nğŸ“… ${new Date().toLocaleString('fa-IR')}`;
            sendToTelegram(telegramMsg);
            
            alert(`ğŸ‰ Ú©ÙˆÛŒÛŒØ² ØªÙ…ÙˆÙ… Ø´Ø¯!\nğŸ† Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: ${score} Ø§Ø² 100\n${message}`);
            window.location.href = 'index.html';
        }
        
        init();
    </script>
</body>
</html>
