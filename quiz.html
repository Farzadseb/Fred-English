<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Quiz - English with Fred</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Tahoma, sans-serif; background: #0b1426; color: white; margin: 0; padding: 20px; min-height: 100vh; }
    .back { position: fixed; top: 20px; left: 20px; width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 10; }
    .card { background: rgba(255,255,255,0.1); border-radius: 25px; padding: 30px; margin: 80px auto 20px; max-width: 400px; backdrop-filter: blur(15px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; }
    .word { font-size: 36px; font-weight: bold; color: #00a8ff; margin: 20px 0; direction: ltr; }
    .hint { font-size: 16px; opacity: 0.85; margin-bottom: 18px; line-height: 1.7; }
    .next { width: 80%; padding: 16px; background: #00a8ff; color: white; border: none; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .options { display: flex; flex-direction: column; gap: 12px; max-width: 400px; margin: 0 auto; }
    .opt { padding: 16px; background: rgba(255,255,255,0.1); border-radius: 18px; font-size: 16px; cursor: pointer; }
    .correct { background: #34c759 !important; color: white; }
    .wrong { background: #ff3b30 !important; color: white; }
    .progress { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 20px 0; max-width: 400px; width: 100%; }
    #prog { width: 0%; height: 100%; background: #00a8ff; transition: 0.3s; }

    .report { display: none; text-align: center; margin-top: 100px; }
    .report-title { font-size: 24px; color: #00a8ff; margin-bottom: 20px; }
    .report-score { font-size: 48px; color: #00ff88; margin: 20px 0; }
    .report-stars { font-size: 50px; letter-spacing: 15px; margin: 30px 0; }
    .report-msg { font-size: 18px; line-height: 1.6; opacity: 0.9; }
  </style>
</head>
<body>

  <div class="back" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i></div>

  <div class="progress"><div id="prog"></div></div>

  <!-- Ú©Ø§Ø±Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ -->
  <div class="card" id="studyCard" style="display:none;">
    <div class="word" id="englishWord"></div>
    <div class="hint" id="persianText"></div>
    <div class="hint" id="defText"></div>
    <button class="next" onclick="nextStudy()">Ø¨Ø¹Ø¯ÛŒ</button>
  </div>

  <!-- Ú©Ø§Ø±Øª Ø³ÙˆØ§Ù„ -->
  <div class="card" id="questionCard" style="display:none;">
    <div class="word" id="q-text"></div>
    <div class="hint" id="q-hint"></div>
  </div>
  <div class="options" id="options" style="display:none;"></div>

  <!-- Ú¯Ø²Ø§Ø±Ø´ -->
  <div class="report" id="report">
    <div class="report-title">Ú¯Ø²Ø§Ø±Ø´ Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§</div>
    <div class="report-score" id="r-best">0%</div>
    <div class="report-stars" id="r-stars">â˜†â˜†â˜†â˜†â˜†</div>
    <div class="report-msg" id="r-msg">Ø´Ø±ÙˆØ¹ Ú©Ù†! Ø§ÙˆÙ„ÛŒÙ† Ù‚Ø¯Ù… Ù…Ù‡Ù…Ù‡ ğŸ’ª</div>
  </div>

  <!-- Ø¨Ø§ÛŒØ¯ window.words Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ú©Ù†Ø¯ -->
  <script src="a1-words.js"></script>

  <script>
    let currentQ = 0, score = 0, wordsList = [];
    const mode = localStorage.getItem('quizMode') || 'fa-en';
    let userInteracted = false;

    const data = Array.isArray(window.words) ? window.words : [];

    function showOnly(which) {
      document.getElementById('studyCard').style.display = (which === 'study') ? 'block' : 'none';
      document.getElementById('questionCard').style.display = (which === 'q') ? 'block' : 'none';
      document.getElementById('options').style.display = (which === 'q') ? 'flex' : 'none';
      document.getElementById('report').style.display = (which === 'r') ? 'block' : 'none';
    }

    // ---------- REVIEW ----------
    if (mode === 'review') {
      showOnly('r');

      const best = parseInt(localStorage.getItem('fredBest') || '0', 10);
      document.getElementById('r-best').innerText = best + "%";
      const filled = Math.floor(best / 20);
      document.getElementById('r-stars').innerText = 'â­'.repeat(filled) + 'â˜†'.repeat(5 - filled);

      const msg =
        best >= 90 ? "Ø¹Ø§Ù„ÛŒ! Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø´Ø¯ÛŒ ğŸš€" :
        best >= 70 ? "Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨! Ù†Ø²Ø¯ÛŒÚ© Ù‚Ù„Ù‡â€ŒØ§ÛŒ ğŸ“ˆ" :
        best >= 50 ? "Ø®ÙˆØ¨Ù‡! Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ â­" :
        best > 0  ? "Ø´Ø±ÙˆØ¹ Ø¹Ø§Ù„ÛŒ! Ù¾ÛŒØ´Ø±ÙØªØª Ù…Ø´Ø®ØµÙ‡ ğŸ’ª" :
                    "Ø´Ø±ÙˆØ¹ Ú©Ù†! Ø§ÙˆÙ„ÛŒÙ† Ù‚Ø¯Ù… Ù…Ù‡Ù…Ù‡ ğŸ˜Š";

      document.getElementById('r-msg').innerText = msg;

    } else {
      // ---------- DATA CHECK ----------
      if (data.length < 10) {
        alert("Ù„ØºØ§Øª Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª");
        window.location.href = 'index.html';
      }

      wordsList = [...data].sort(() => Math.random() - 0.5);

      // ---------- STUDY MODE ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ study ----------
      if (mode === 'study') {
        currentQ = -1;
        nextStudy();
      } else {
        // ---------- QUIZ MODES: fa-en, en-fa, word-def, def-word ----------
        currentQ = 0;
        score = 0;
        nextQuestion();
      }
    }

    // --------- STUDY ----------
    function nextStudy() {
      currentQ++;
      if (currentQ >= wordsList.length) currentQ = 0;

      const item = wordsList[currentQ];
      showOnly('study');

      document.getElementById('prog').style.width =
        ((currentQ + 1) / wordsList.length * 100) + "%";

      document.getElementById('englishWord').innerText = item.word || "";
      document.getElementById('persianText').innerText = item.translation || "";
      document.getElementById('defText').innerText = item.definition || item.ex_en || "";

      if (userInteracted && localStorage.getItem('fredMute') !== 'true') speak(item.word);
    }

    // --------- QUIZ ----------
    function nextQuestion() {
      if (currentQ >= 10) { endQuiz(); return; }

      const item = wordsList[currentQ];
      showOnly('q');

      document.getElementById('prog').style.width =
        ((currentQ + 1) / 10 * 100) + "%";

      let qText = "", correct = "", hint = "", choiceGetter = null;

      // 1) Persian â†’ English  (Ø³ÙˆØ§Ù„ ÙØ§Ø±Ø³ÛŒØŒ Ø¬ÙˆØ§Ø¨ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)
      if (mode === 'fa-en') {
        qText = item.translation || "";
        correct = item.word || "";
        hint = "Ú©Ù„Ù…Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¯Ø±Ø³Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
        choiceGetter = (w) => w.word || "";

      // 2) English â†’ Persian  (Ø³ÙˆØ§Ù„ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø¬ÙˆØ§Ø¨ ÙØ§Ø±Ø³ÛŒ)
      } else if (mode === 'en-fa') {
        qText = item.word || "";
        correct = item.translation || "";
        hint = "Ù…Ø¹Ø§Ø¯Ù„ ÙØ§Ø±Ø³ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
        choiceGetter = (w) => w.translation || "";

      // 4) Word â†’ Definition  (Ø³ÙˆØ§Ù„ Ú©Ù„Ù…Ù‡ØŒ Ø¬ÙˆØ§Ø¨ ØªØ¹Ø±ÛŒÙ)
      } else if (mode === 'word-def') {
        qText = item.word || "";
        correct = (item.definition || item.ex_en || "");
        hint = "ØªØ¹Ø±ÛŒÙ Ø¯Ø±Ø³Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
        choiceGetter = (w) => (w.definition || w.ex_en || "");

      // 5) Definition â†’ Word (Ø³ÙˆØ§Ù„ ØªØ¹Ø±ÛŒÙØŒ Ø¬ÙˆØ§Ø¨ Ú©Ù„Ù…Ù‡)
      } else if (mode === 'def-word') {
        qText = (item.definition || item.ex_en || "ØªØ¹Ø±ÛŒÙ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");
        correct = item.word || "";
        hint = "Ø§ÛŒÙ† ØªØ¹Ø±ÛŒÙ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ú©Ù„Ù…Ù‡ Ø§Ø³ØªØŸ";
        choiceGetter = (w) => w.word || "";

      } else {
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('q-text').innerText = qText;
      document.getElementById('q-hint').innerText = hint;

      // ØµØ¯Ø§ Ù‡Ù…ÛŒØ´Ù‡ Ú©Ù„Ù…Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ø¯ (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯)
      if (userInteracted && localStorage.getItem('fredMute') !== 'true') speak(item.word);

      // Ø³Ø§Ø®Øª Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
      const choices = [];
      if (correct) choices.push(correct);

      let guard = 0;
      while (choices.length < 4 && guard < 500) {
        guard++;
        const rand = wordsList[Math.floor(Math.random() * wordsList.length)];
        const val = choiceGetter(rand);
        if (val && !choices.includes(val)) choices.push(val);
      }

      // Ø§Ú¯Ø± ØªØ¹Ø§Ø±ÛŒÙ Ú©Ù… Ø¨ÙˆØ¯ØŒ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¨Ø§ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù…Ù…Ù†ÙˆØ¹Ø› ÙˆÙ„ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø±Ø´
      while (choices.length < 4) choices.push("â€”");

      choices.sort(() => Math.random() - 0.5);

      const container = document.getElementById('options');
      container.innerHTML = '';

      choices.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'opt';
        btn.innerText = c;

        btn.onclick = () => {
          userInteracted = true;
          document.querySelectorAll('.opt').forEach(b => b.onclick = null);

          if (c === correct) {
            btn.classList.add('correct');
            score++;
          } else {
            btn.classList.add('wrong');
            document.querySelectorAll('.opt').forEach(b => {
              if (b.innerText === correct) b.classList.add('correct');
            });
          }

          setTimeout(() => {
            currentQ++;
            nextQuestion();
          }, 1200);
        };

        container.appendChild(btn);
      });
    }

    function speak(word) {
      if (!word) return;
      const utter = new SpeechSynthesisUtterance(word);
      utter.lang = 'en-US';
      utter.rate = 0.5;
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    function endQuiz() {
      const p = Math.round((score / 10) * 100);
      const best = parseInt(localStorage.getItem('fredBest') || '0', 10);

      if (p > best) localStorage.setItem('fredBest', String(p));

      alert(`ØªÙ…Ø§Ù…!\nØ§Ù…ØªÛŒØ§Ø²: ${p}%\n${p > best ? "Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯!" : "Ø¨Ù‡ØªØ±ÛŒÙ†: " + best + "%"}`);
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
