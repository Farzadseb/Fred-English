<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Quiz - English with Fred</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Tahoma, sans-serif; background: #0b1426; color: white; margin: 0; padding: 20px; min-height: 100vh; }
    .back { position: fixed; top: 20px; left: 20px; width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 10; }
    .card { background: rgba(255,255,255,0.1); border-radius: 25px; padding: 30px; margin: 80px auto 20px; max-width: 400px; backdrop-filter: blur(15px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; }
    .word { font-size: 36px; font-weight: bold; color: #00a8ff; margin: 20px 0; direction: ltr; }
    .hint { font-size: 16px; opacity: 0.85; margin-bottom: 18px; line-height: 1.7; }
    .next { width: 80%; padding: 16px; background: #00a8ff; color: white; border: none; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .options { display: flex; flex-direction: column; gap: 12px; max-width: 400px; margin: 0 auto; }
    .opt { padding: 16px; background: rgba(255,255,255,0.1); border-radius: 18px; font-size: 16px; cursor: pointer; }
    .correct { background: #34c759 !important; color: white; }
    .wrong { background: #ff3b30 !important; color: white; }
    .progress { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 20px 0; max-width: 400px; width: 100%; }
    #prog { width: 0%; height: 100%; background: #00a8ff; transition: 0.3s; }

    .report { display: none; text-align: center; margin-top: 100px; }
    .report-title { font-size: 24px; color: #00a8ff; margin-bottom: 20px; }
    .report-score { font-size: 48px; color: #00ff88; margin: 20px 0; }
    .report-stars { font-size: 50px; letter-spacing: 15px; margin: 30px 0; }
    .report-msg { font-size: 18px; line-height: 1.6; opacity: 0.9; }
  </style>
</head>
<body>

  <div class="back" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i></div>

  <div class="progress"><div id="prog"></div></div>

  <div class="card" id="studyCard" style="display:none;">
    <div class="word" id="englishWord"></div>
    <div class="hint" id="persianText"></div>
    <div class="hint" id="defText"></div>
    <button class="next" onclick="nextStudy()">Ø¨Ø¹Ø¯ÛŒ</button>
  </div>

  <div class="card" id="questionCard" style="display:none;">
    <div class="word" id="q-text"></div>
    <div class="hint" id="q-hint"></div>
  </div>
  <div class="options" id="options" style="display:none;"></div>

  <div class="report" id="report">
    <div class="report-title">Ú¯Ø²Ø§Ø±Ø´ Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§</div>
    <div class="report-score" id="r-best">0%</div>
    <div class="report-stars" id="r-stars">â˜†â˜†â˜†â˜†â˜†</div>
    <div class="report-msg" id="r-msg">Ø´Ø±ÙˆØ¹ Ú©Ù†! Ø§ÙˆÙ„ÛŒÙ† Ù‚Ø¯Ù… Ù…Ù‡Ù…Ù‡ ğŸ’ª</div>
  </div>

  <script src="a1-words.js"></script>

  <script>
    let currentQ = 0, score = 0, wordsList = [];
    const mode = localStorage.getItem('quizMode') || 'fa-en';
    let userInteracted = true;

    speechSynthesis.getVoices();

    const data = Array.isArray(window.words) ? window.words : [];

    function showOnly(which) {
      studyCard.style.display = which === 'study' ? 'block' : 'none';
      questionCard.style.display = which === 'q' ? 'block' : 'none';
      options.style.display = which === 'q' ? 'flex' : 'none';
      report.style.display = which === 'r' ? 'block' : 'none';
    }

    if (mode === 'review') {
      showOnly('r');
      const best = parseInt(localStorage.getItem('fredBest') || '0', 10);
      r-best.innerText = best + "%";
      const filled = Math.floor(best / 20);
      r-stars.innerText = 'â­'.repeat(filled) + 'â˜†'.repeat(5 - filled);
      r-msg.innerText =
        best >= 90 ? "Ø¹Ø§Ù„ÛŒ! Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø´Ø¯ÛŒ ğŸš€" :
        best >= 70 ? "Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨! Ù†Ø²Ø¯ÛŒÚ© Ù‚Ù„Ù‡â€ŒØ§ÛŒ ğŸ“ˆ" :
        best >= 50 ? "Ø®ÙˆØ¨Ù‡! Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ â­" :
        best > 0  ? "Ø´Ø±ÙˆØ¹ Ø¹Ø§Ù„ÛŒ! Ù¾ÛŒØ´Ø±ÙØªØª Ù…Ø´Ø®ØµÙ‡ ğŸ’ª" :
                    "Ø´Ø±ÙˆØ¹ Ú©Ù†! Ø§ÙˆÙ„ÛŒÙ† Ù‚Ø¯Ù… Ù…Ù‡Ù…Ù‡ ğŸ˜Š";
    } else {
      if (data.length < 10) { alert("Ù„ØºØ§Øª Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª"); location.href='index.html'; }
      wordsList = [...data].sort(() => Math.random() - 0.5);
      if (mode === 'study') { currentQ = -1; nextStudy(); }
      else { currentQ = 0; score = 0; nextQuestion(); }
    }

    function nextStudy() {
      currentQ = (currentQ + 1) % wordsList.length;
      const w = wordsList[currentQ];
      showOnly('study');
      prog.style.width = ((currentQ + 1) / wordsList.length * 100) + "%";
      englishWord.innerText = w.word;
      persianText.innerText = w.translation;
      defText.innerText = w.definition || "";
      speak(w.word);
    }

    function nextQuestion() {
      if (currentQ >= 10) { endQuiz(); return; }
      const w = wordsList[currentQ];
      showOnly('q');
      prog.style.width = ((currentQ + 1) / 10 * 100) + "%";

      let qText, correct, getChoice, hint;

      if (mode === 'fa-en') {
        qText = w.translation; correct = w.word;
        getChoice = x => x.word; hint = "Ú©Ù„Ù…Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¯Ø±Ø³Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
      } else if (mode === 'en-fa') {
        qText = w.word; correct = w.translation;
        getChoice = x => x.translation; hint = "Ù…Ø¹Ø§Ø¯Ù„ ÙØ§Ø±Ø³ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
      } else if (mode === 'word-def') {
        qText = w.word; correct = w.definition;
        getChoice = x => x.definition; hint = "ØªØ¹Ø±ÛŒÙ Ø¯Ø±Ø³Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
      } else if (mode === 'def-word') {
        qText = w.definition; correct = w.word;
        getChoice = x => x.word; hint = "Ø§ÛŒÙ† ØªØ¹Ø±ÛŒÙ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ú©Ù„Ù…Ù‡ Ø§Ø³ØªØŸ";
      }

      q-text.innerText = qText;
      q-hint.innerText = hint;
      speak(w.word);

      const choices = [correct];
      while (choices.length < 4) {
        const v = getChoice(wordsList[Math.floor(Math.random() * wordsList.length)]);
        if (v && !choices.includes(v)) choices.push(v);
      }
      choices.sort(() => Math.random() - 0.5);

      options.innerHTML = '';
      choices.forEach(c => {
        const d = document.createElement('div');
        d.className = 'opt';
        d.innerText = c;
        d.onclick = () => {
          document.querySelectorAll('.opt').forEach(x => x.onclick = null);
          if (c === correct) { d.classList.add('correct'); score++; }
          else {
            d.classList.add('wrong');
            document.querySelectorAll('.opt').forEach(x => {
              if (x.innerText === correct) x.classList.add('correct');
            });
          }
          setTimeout(() => { currentQ++; nextQuestion(); }, 300);
        };
        options.appendChild(d);
      });
    }

    function speak(word) {
      if (!word) return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(word);
      u.lang = 'en-US';
      u.rate = 0.5;
      const v = speechSynthesis.getVoices();
      if (v.length) u.voice = v.find(x => x.lang === 'en-US') || v[0];
      speechSynthesis.speak(u);
    }

    function endQuiz() {
      const p = Math.round((score / 10) * 100);
      const best = parseInt(localStorage.getItem('fredBest') || '0', 10);
      if (p > best) localStorage.setItem('fredBest', p);
      alert(`ØªÙ…Ø§Ù…!\nØ§Ù…ØªÛŒØ§Ø²: ${p}%\n${p > best ? "Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯!" : "Ø¨Ù‡ØªØ±ÛŒÙ†: " + best + "%"}`);
      location.href = 'index.html';
    }
  </script>
</body>
</html>
