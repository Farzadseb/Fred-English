<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>English with Fred Elite</title>
    <style>
        :root {
            --bg-grad: linear-gradient(135deg, #f5f7f8 0%, #d1d9e6 100%);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.5);
            --text-main: #2d3436;
            --primary-blue: #4a90e2; /* Ø¢Ø¨ÛŒ Ù…Ù„Ø§ÛŒÙ… Ù…Ø¯ Ù†Ø¸Ø± Ø´Ù…Ø§ */
            --soft-indigo: #6c5ce7;
        }

        [data-theme="dark"] {
            --bg-grad: linear-gradient(135deg, #1e272e 0%, #050505 100%);
            --glass-bg: rgba(30, 39, 46, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f1f2f6;
            --primary-blue: #54a0ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: all 0.25s ease; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-grad);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center; /* Ù…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† Ø¹Ù…ÙˆØ¯ÛŒ */
            min-height: 100vh;
            padding: 20px;
        }

        .screen {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%;
            max-width: 400px;
            min-height: 520px; /* Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø±ØªÙØ§Ø¹ Ú©Ø§Ø¯Ø± Ø¨Ø±Ø§ÛŒ ØªÙ†Ø§Ø³Ø¨ Ø¨Ù‡ØªØ± */
            border-radius: 40px;
            padding: 30px 25px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Ù¾Ø®Ø´ Ø´Ø¯Ù† Ù…Ø­ØªÙˆØ§ Ø¯Ø± Ú©Ù„ Ø§Ø±ØªÙØ§Ø¹ */
            position: relative;
        }

        .header-nav {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .header-title { 
            font-size: 24px; 
            font-weight: 850; 
            color: var(--text-main); 
            margin: 0;
            text-align: center;
            flex-grow: 1;
        }

        .top-icon {
            font-size: 22px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-list {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-mode {
            background: var(--glass-bg);
            border: 1.5px solid var(--glass-border);
            padding: 18px;
            border-radius: 20px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-main);
            font-size: 16px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }

        /* ÙÙ‚Ø· Ù…ØªÙ† Ø±Ù†Ú¯ÛŒ Ø´ÙˆØ¯ - Ø·Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡ Ø´Ù…Ø§ */
        .btn-mode.active {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            background: var(--glass-bg); /* Ú©Ø§Ø¯Ø± Ø±Ù†Ú¯ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.15);
        }

        .btn-action {
            border: none;
            color: white;
            font-weight: 700;
            width: 100%;
            padding: 20px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            background: var(--primary-blue);
            box-shadow: 0 10px 20px rgba(74, 144, 226, 0.3);
            margin-bottom: 10px;
        }

        .btn-review {
            background: var(--soft-indigo);
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.25);
        }

        /* ØµÙØ­Ù‡ Ø¢Ø²Ù…ÙˆÙ† */
        .q-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .q-text { font-size: 1.6rem; font-weight: 800; text-align: center; direction: ltr; color: var(--text-main); margin-bottom: 30px; }
        
        .nav-btn { background: rgba(0,0,0,0.05); border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; color: var(--text-main); font-size: 18px; }
        
        .correct { background: #55efc4 !important; color: #00b894 !important; border: none !important; }
        .wrong { background: #ff7675 !important; color: white !important; border: none !important; }
    </style>
</head>
<body>

    <div id="setup" class="screen">
        <div class="header-nav">
            <div class="top-icon" onclick="toggleTheme()">ğŸŒ“</div>
            <h1 class="header-title">English with Fred</h1>
            <div id="mainMuteBtn" class="top-icon" onclick="toggleMute()">ğŸ”Š</div>
        </div>
        
        <div class="mode-list">
            <div class="btn-mode active" onclick="setMode(1, this)">Û±. Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(2, this)">Û². ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(3, this)">Û³. Ù„ØºØª Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ</div>
            <div class="btn-mode" onclick="setMode(4, this)">Û´. ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª</div>
        </div>
        
        <div>
            <button class="btn-action" onclick="startQuiz(false)">ğŸš€ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯</button>
            <button class="btn-action btn-review" onclick="startQuiz(true)">ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª</button>
        </div>
    </div>

    <div id="quiz" class="screen" style="display: none;">
        <div class="header-nav">
            <button class="nav-btn" onclick="say()">ğŸ”Š</button>
            <div style="font-weight: bold; color: var(--text-main); font-size: 14px; opacity: 0.7;" id="progressText">1 / 20</div>
            <button class="nav-btn" onclick="location.reload()">âœ•</button>
        </div>

        <div class="q-container">
            <div id="qDisplay" class="q-text"></div>
            <div id="opts" style="width: 100%; display: grid; gap: 12px;"></div>
        </div>
    </div>

    <script src="dic.js"></script>

    <script>
        let db = [], session = [], idx = 0, currentMode = 1, busy = false;
        let isMuted = false;
        let mistakeBank = JSON.parse(localStorage.getItem('fred_mistakes_v4')) || [];

        function toggleTheme() {
            const body = document.body;
            body.getAttribute('data-theme') === 'dark' ? body.removeAttribute('data-theme') : body.setAttribute('data-theme', 'dark');
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('mainMuteBtn').textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
            if(isMuted) window.speechSynthesis.cancel();
        }

        function setMode(m, el) { 
            currentMode = m; 
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active')); 
            el.classList.add('active'); 
        }

        function startQuiz(fromMistakes) {
            let source = fromMistakes ? mistakeBank : (typeof permanentWords !== 'undefined' ? permanentWords.trim().split('\n') : []);
            if(fromMistakes && mistakeBank.length === 0) return alert("Ù„ÛŒØ³Øª Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!");

            db = source.map(l => {
                let p = l.split(' â€” ');
                return p.length >= 2 ? { en: p[0].trim(), fa: p[1].trim(), def: p[2] ? p[2].trim() : "Def" } : null;
            }).filter(x => x);

            session = [...db].sort(() => 0.5 - Math.random());
            if(!fromMistakes) session = session.slice(0, 20); 
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('quiz').style.display = 'flex';
            idx = 0; render();
        }

        function render() {
            busy = false; const q = session[idx]; let qText = "", ans = "";
            document.getElementById('progressText').textContent = `${idx + 1} / ${session.length}`;

            if(currentMode === 1) { qText = q.en; ans = q.fa; }
            else if(currentMode === 2) { qText = q.fa; ans = q.en; }
            else if(currentMode === 3) { qText = q.en; ans = q.def; }
            else { qText = q.def; ans = q.en; }

            document.getElementById('qDisplay').textContent = qText;
            
            let opts = [ans];
            let pool = db.filter(v => v.en !== q.en).map(v => {
                if(currentMode === 1) return v.fa; if(currentMode === 2) return v.en;
                if(currentMode === 3) return v.def; return v.en;
            });
            while(opts.length < 4 && pool.length) {
                let r = pool.splice(Math.floor(Math.random()*pool.length), 1)[0];
                if(!opts.includes(r)) opts.push(r);
            }
            opts.sort(() => 0.5 - Math.random());

            const div = document.getElementById('opts');
            div.innerHTML = '';
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'btn-mode'; b.textContent = o; // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù…Ø§Ù† Ø§Ø³ØªØ§ÛŒÙ„ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
                b.onclick = () => {
                    if(busy) return; busy = true;
                    if(o === ans) b.classList.add('correct');
                    else {
                        b.classList.add('wrong');
                        if(!mistakeBank.some(m => m.en === q.en)) {
                            mistakeBank.push(q);
                            localStorage.setItem('fred_mistakes_v4', JSON.stringify(mistakeBank));
                        }
                        div.querySelectorAll('button').forEach(btn => { if(btn.textContent === ans) btn.classList.add('correct'); });
                    }
                    setTimeout(() => { idx++; if(idx < session.length) render(); else location.reload(); }, 1200);
                };
                div.appendChild(b);
            });
            say(); 
        }

        function say() {
            if (!session[idx] || isMuted) return;
            let textToSay = (currentMode === 4) ? session[idx].def : session[idx].en;
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(textToSay);
            u.lang = 'en-US'; u.rate = 0.6;
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
