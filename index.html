<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>English with Fred Elite</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.4);
            --ios-blue: #007AFF;
            --ios-indigo: #5856D6;
            --text-main: #1d1d1f;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .screen {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            width: 100%;
            max-width: 420px;
            border-radius: 35px;
            padding: 30px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .header-nav {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .exit-btn {
            background: rgba(0,0,0,0.06);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-btn-top {
            background: rgba(0, 122, 255, 0.1);
            color: var(--ios-blue);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .audio-btn-top:active { transform: scale(0.9); background: rgba(0, 122, 255, 0.2); }

        .header-title {
            font-size: 26px;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(to bottom, #333, #000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .best-score {
            font-size: 13px;
            color: var(--ios-indigo);
            font-weight: 700;
            background: rgba(88, 86, 214, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            margin-bottom: 25px;
        }

        .btn-mode {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 18px;
            width: 100%;
            margin-bottom: 10px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            transition: 0.3s;
        }

        .btn-mode.active {
            background: white;
            border-color: var(--ios-blue);
            color: var(--ios-blue);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.15);
        }

        .q-container {
            width: 100%;
            min-height: 110px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .q-text {
            font-size: 1.6rem;
            font-weight: 700;
            text-align: center;
            direction: ltr;
            line-height: 1.4;
            color: var(--text-main);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            width: 100%;
        }

        .btn-opt {
            padding: 18px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.8);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .correct { background: #34C759 !important; color: white !important; border: none; }
        .wrong { background: #FF3B30 !important; color: white !important; border: none; }

        .btn-action {
            border: none;
            color: white;
            font-weight: 700;
            width: 100%;
            padding: 20px;
            border-radius: 22px;
            margin-top: 15px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="setup" class="screen">
        <h1 class="header-title">English with Fred</h1>
        <div id="bestDisplay" class="best-score">Best Record: 0%</div>
        
        <div style="width: 100%; margin-bottom: 20px;">
            <div class="btn-mode active" onclick="setMode(1, this)">Û±. Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(2, this)">Û². ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(3, this)">Û³. Ù„ØºØª Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ (A1)</div>
            <div class="btn-mode" onclick="setMode(4, this)">Û´. ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª (A1)</div>
        </div>
        
        <button class="btn-action" style="background: var(--ios-blue);" onclick="startQuiz(false)">ğŸš€ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯</button>
        <button class="btn-action" style="background: var(--ios-indigo);" onclick="startQuiz(true)">ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª</button>
    </div>

    <div id="quiz" class="screen" style="display: none;">
        <div class="header-nav">
            <button class="exit-btn" onclick="location.reload()">âœ•</button>
            <div style="font-weight: bold; color: #888; font-size: 14px;" id="progressText">1/20</div>
            <button class="audio-btn-top" onclick="say()">ğŸ”Š</button>
        </div>

        <div class="q-container">
            <div id="qDisplay" class="q-text"></div>
        </div>

        <div class="options-grid" id="opts"></div>
    </div>

    <script src="dic.js"></script>

    <script>
        let db = [], session = [], idx = 0, currentMode = 1, busy = false;
        let mistakeBank = JSON.parse(localStorage.getItem('fred_mistakes_v4')) || [];
        
        document.getElementById('bestDisplay').textContent = `Best Record: ${localStorage.getItem('fred_best_v4') || 0}%`;

        function setMode(m, el) { 
            currentMode = m; 
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active')); 
            el.classList.add('active'); 
        }

        function startQuiz(fromMistakes) {
            let source = fromMistakes ? mistakeBank : (typeof permanentWords !== 'undefined' ? permanentWords.trim().split('\n') : []);
            if(fromMistakes && mistakeBank.length === 0) return alert("Ù„ÛŒØ³Øª Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!");

            db = source.map(l => {
                let p = l.split(' â€” ');
                return p.length >= 2 ? { en: p[0].trim(), fa: p[1].trim(), def: p[2] ? p[2].trim() : "Definition" } : null;
            }).filter(x => x);

            session = [...db].sort(() => 0.5 - Math.random());
            if(!fromMistakes) session = session.slice(0, 20); 
            
            idx = 0;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('quiz').style.display = 'flex';
            render();
        }

        function render() {
            busy = false; 
            const q = session[idx]; 
            let qText = "", ans = "";
            
            document.getElementById('progressText').textContent = `Ø³ÙˆØ§Ù„ ${idx + 1} Ø§Ø² ${session.length}`;

            if(currentMode === 1) { qText = q.en; ans = q.fa; }
            else if(currentMode === 2) { qText = q.fa; ans = q.en; }
            else if(currentMode === 3) { qText = q.en; ans = q.def; }
            else { qText = q.def; ans = q.en; }

            document.getElementById('qDisplay').textContent = qText;
            
            let opts = [ans];
            let pool = db.filter(v => v.en !== q.en).map(v => {
                if(currentMode === 1) return v.fa;
                if(currentMode === 2) return v.en;
                if(currentMode === 3) return v.def;
                return v.en;
            });
            
            while(opts.length < 4 && pool.length) {
                let r = pool.splice(Math.floor(Math.random()*pool.length), 1)[0];
                if(!opts.includes(r)) opts.push(r);
            }
            opts.sort(() => 0.5 - Math.random());

            const div = document.getElementById('opts');
            div.innerHTML = '';
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'btn-opt';
                b.textContent = o;
                b.onclick = () => {
                    if(busy) return; busy = true;
                    if(o === ans) {
                        b.classList.add('correct');
                    } else {
                        b.classList.add('wrong');
                        if(!mistakeBank.some(m => m.en === q.en)) {
                            mistakeBank.push(q);
                            localStorage.setItem('fred_mistakes_v4', JSON.stringify(mistakeBank));
                        }
                        div.querySelectorAll('button').forEach(btn => { if(btn.textContent === ans) btn.classList.add('correct'); });
                    }
                    setTimeout(() => { 
                        idx++; 
                        if(idx < session.length) render(); 
                        else { alert("ØªÙ…Ø±ÛŒÙ† ØªÙ…Ø§Ù… Ø´Ø¯! Ø¢ÙØ±ÛŒÙ†."); location.reload(); }
                    }, 1500);
                };
                div.appendChild(b);
            });
            say(); 
        }

        function say() {
            if (!session[idx]) return;
            // Ø¯Ø± ØªÙ…Ø§Ù… Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ØŒ Ù‡Ø¯Ù Ø´Ù†ÛŒØ¯Ù† ØªÙ„ÙØ¸ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù„ØºØª Ø§Ø³Øª. 
            // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª "ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª" (Û´) Ø¨Ø§Ø´Ø¯ØŒ Ù…ØªÙ† ØªØ¹Ø±ÛŒÙ Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ø¯ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ù„ØºØª Ø±Ø§.
            let textToSay = (currentMode === 4) ? session[idx].def : session[idx].en;
            
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(textToSay);
            u.lang = 'en-US';
            u.rate = 0.6; 
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
