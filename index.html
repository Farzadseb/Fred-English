<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English with Fred</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; }
        body { font-family: -apple-system, sans-serif; background: var(--ios-bg); margin: 0; display: flex; justify-content: center; padding-top: 20px; }
        .screen { background: #fff; width: 92%; max-width: 420px; border-radius: 30px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
        .header-title { font-size: 26px; font-weight: 800; margin-bottom: 20px; color: #000; }
        .btn-main { border: none; color: white; font-weight: 700; width: 100%; padding: 18px; border-radius: 20px; margin-bottom: 12px; font-size: 17px; cursor: pointer; background: var(--ios-blue); }
        .btn-mode { background: #fff; border: 1px solid #d1d1d6; padding: 15px; border-radius: 16px; width: 100%; margin-bottom: 8px; font-weight: 600; cursor: pointer; }
        .btn-mode.active { border: 2.5px solid var(--ios-blue); color: var(--ios-blue); background: #f0f7ff; }
        .q-text { font-size: 2.2rem; font-weight: 800; margin: 35px 0; width: 100%; text-align: center; direction: ltr; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; }
        .btn-opt { padding: 18px; border-radius: 18px; border: 1px solid #d1d1d6; background: #fff; font-size: 16px; font-weight: 600; }
        .correct { background: #34C759 !important; color: white !important; border: none; }
        .wrong { background: #FF3B30 !important; color: white !important; border: none; }
        .exit-btn { position: absolute; top: 15px; left: 15px; background: #eee; border: none; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setup" class="screen">
        <h1 class="header-title">English with Fred</h1>
        <div style="width: 100%; margin-bottom: 15px;">
            <div class="btn-mode active" onclick="setMode(1, this)">Û±. Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(2, this)">Û². ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(3, this)">Û³. Ù„ØºØª Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ</div>
            <div class="btn-mode" onclick="setMode(4, this)">Û´. ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª</div>
        </div>
        <button class="btn-main" onclick="startQuiz(false)">ğŸš€ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†</button>
        <button class="btn-main" style="background:#5856D6;" onclick="startQuiz(true)">ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª</button>
    </div>

    <div id="quiz" class="screen" style="display: none;">
        <button class="exit-btn" onclick="location.reload()">âœ•</button>
        <div id="qDisplay" class="q-text"></div>
        <div id="audioBtn" style="font-size: 3rem; margin-bottom: 20px; cursor: pointer;" onclick="say()">ğŸ”Š</div>
        <div class="options-grid" id="opts"></div>
    </div>

    <script src="dic.js"></script>

    <script>
        let db = [], session = [], idx = 0, currentMode = 1, busy = false;
        let mistakeBank = JSON.parse(localStorage.getItem('fred_mistakes_v3')) || [];

        function setMode(m, el) { 
            currentMode = m; 
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active')); 
            el.classList.add('active'); 
        }

        function startQuiz(fromMistakes) {
            let data = fromMistakes ? mistakeBank : permanentWords.trim().split('\n');
            if(fromMistakes && mistakeBank.length === 0) return alert("Ù‡Ù†ÙˆØ² Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!");

            db = data.map(l => {
                let p = l.split(' â€” ');
                return p.length >= 2 ? { en: p[0].trim(), fa: p[1].trim(), def: p[2] ? p[2].trim() : "Basic" } : null;
            }).filter(x => x);

            session = [...db].sort(() => 0.5 - Math.random()).slice(0, 20); // Ù‡Ø± Ø¨Ø§Ø± Û²Û° Ø³ÙˆØ§Ù„ ØªØµØ§Ø¯ÙÛŒ
            idx = 0;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('quiz').style.display = 'flex';
            render();
        }

        function render() {
            busy = false; const q = session[idx]; let qText = "", ans = "";
            if(currentMode === 1) { qText = q.en; ans = q.fa; }
            else if(currentMode === 2) { qText = q.fa; ans = q.en; }
            else if(currentMode === 3) { qText = q.en; ans = q.def; }
            else { qText = q.def; ans = q.en; }

            document.getElementById('qDisplay').textContent = qText;
            document.getElementById('audioBtn').style.display = (currentMode === 1 || currentMode === 3) ? 'block' : 'none';
            
            let opts = [ans], pool = db.filter(v => v.en !== q.en).map(v => {
                if(currentMode === 1) return v.fa; if(currentMode === 2) return v.en; if(currentMode === 3) return v.def; return v.en;
            });
            while(opts.length < 4 && pool.length) { 
                let r = pool.splice(Math.floor(Math.random()*pool.length), 1)[0]; 
                if(!opts.includes(r)) opts.push(r); 
            }
            opts.sort(() => 0.5 - Math.random());

            const div = document.getElementById('opts'); div.innerHTML = '';
            opts.forEach(o => {
                const b = document.createElement('button'); b.className = 'btn-opt'; b.textContent = o;
                b.onclick = () => {
                    if(busy) return; busy = true;
                    if(o === ans) { b.classList.add('correct'); } 
                    else {
                        b.classList.add('wrong');
                        if(!mistakeBank.some(m => m.en === q.en)) {
                            mistakeBank.push(q);
                            localStorage.setItem('fred_mistakes_v3', JSON.stringify(mistakeBank));
                        }
                        div.querySelectorAll('button').forEach(btn => { if(btn.textContent === ans) btn.classList.add('correct'); });
                    }
                    setTimeout(() => { idx++; if(idx < session.length) render(); else location.reload(); }, 1200);
                };
                div.appendChild(b);
            });
            if(currentMode === 1 || currentMode === 3) say();
        }
        function say() { const u = new SpeechSynthesisUtterance(session[idx].en); u.lang = 'en-US'; window.speechSynthesis.speak(u); }
    </script>
</body>
</html>
