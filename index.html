<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English with Fred</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --ios-indigo: #5856D6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--ios-bg); margin: 0; display: flex; justify-content: center; padding-top: 20px; min-height: 100vh; }
        .screen { background: #fff; width: 92%; max-width: 400px; border-radius: 30px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; position: relative; height: fit-content; }
        .header-title { font-size: 24px; font-weight: 800; margin-bottom: 5px; color: #000; }
        .best-score { font-size: 14px; color: var(--ios-indigo); margin-bottom: 20px; font-weight: 600; }
        .btn-main { border: none; color: white; font-weight: 700; width: 100%; padding: 18px; border-radius: 20px; margin-bottom: 12px; font-size: 17px; cursor: pointer; background: var(--ios-blue); transition: 0.2s; }
        .btn-mode { background: #fff; border: 1px solid #d1d1d6; padding: 14px; border-radius: 16px; width: 100%; margin-bottom: 8px; font-weight: 600; cursor: pointer; text-align: center; font-size: 15px; }
        .btn-mode.active { border: 2.5px solid var(--ios-blue); color: var(--ios-blue); background: #f0f7ff; }
        .q-text { font-size: 1.8rem; font-weight: 800; margin: 25px 0; width: 100%; text-align: center; direction: ltr; line-height: 1.4; color: #000; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; }
        .btn-opt { padding: 16px; border-radius: 18px; border: 1px solid #d1d1d6; background: #fff; font-size: 16px; font-weight: 600; width: 100%; transition: 0.2s; color: #000; }
        .correct { background: #34C759 !important; color: white !important; border: none; }
        .wrong { background: #FF3B30 !important; color: white !important; border: none; }
        .exit-btn { position: absolute; top: 15px; left: 15px; background: #eee; border: none; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; z-index: 10; }
        #audioBtn { font-size: 3rem; margin-bottom: 15px; cursor: pointer; user-select: none; }
    </style>
</head>
<body>

    <div id="setup" class="screen">
        <h1 class="header-title">English with Fred</h1>
        <div id="bestDisplay" class="best-score">Best Record: 0%</div>
        
        <div style="width: 100%; margin-bottom: 15px;">
            <div class="btn-mode active" onclick="setMode(1, this)">Û±. Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(2, this)">Û². ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(3, this)">Û³. Ù„ØºØª Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ (A1)</div>
            <div class="btn-mode" onclick="setMode(4, this)">Û´. ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª (A1)</div>
        </div>
        
        <button class="btn-main" onclick="startQuiz(false)">ğŸš€ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯</button>
        <button class="btn-main" style="background:var(--ios-indigo);" onclick="startQuiz(true)">ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª</button>
    </div>

    <div id="quiz" class="screen" style="display: none;">
        <button class="exit-btn" onclick="location.reload()">âœ•</button>
        <div id="qDisplay" class="q-text"></div>
        <div id="audioBtn" onclick="say()">ğŸ”Š</div>
        <div class="options-grid" id="opts"></div>
    </div>

    <script src="dic.js"></script>

    <script>
        let db = [], session = [], idx = 0, currentMode = 1, busy = false;
        // Ø¨Ø§Ù†Ú© Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ù†Ø³Ø®Ù‡ Û´ Ø¨Ø±Ø§ÛŒ Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø§Ø² ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        let mistakeBank = JSON.parse(localStorage.getItem('fred_mistakes_v4')) || [];
        
        document.getElementById('bestDisplay').textContent = `Best Record: ${localStorage.getItem('fred_best_v4') || 0}%`;

        function setMode(m, el) { 
            currentMode = m; 
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active')); 
            el.classList.add('active'); 
        }

        function startQuiz(fromMistakes) {
            let source = fromMistakes ? mistakeBank : (typeof permanentWords !== 'undefined' ? permanentWords.trim().split('\n') : []);
            
            if(fromMistakes && mistakeBank.length === 0) {
                alert("Ù„ÛŒØ³Øª Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!");
                return;
            }
            if(!fromMistakes && source.length === 0) {
                alert("Ø®Ø·Ø§: ÙØ§ÛŒÙ„ Ù„ØºØ§Øª (dic.js) Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.");
                return;
            }

            db = source.map(l => {
                let p = l.split(' â€” ');
                return p.length >= 2 ? { en: p[0].trim(), fa: p[1].trim(), def: p[2] ? p[2].trim() : "Basic Definition" } : null;
            }).filter(x => x);

            session = [...db].sort(() => 0.5 - Math.random());
            if(!fromMistakes) session = session.slice(0, 20); 
            
            idx = 0;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('quiz').style.display = 'flex';
            render();
        }

        function render() {
            busy = false; 
            const q = session[idx]; 
            let qText = "", ans = "";
            
            if(currentMode === 1) { qText = q.en; ans = q.fa; }
            else if(currentMode === 2) { qText = q.fa; ans = q.en; }
            else if(currentMode === 3) { qText = q.en; ans = q.def; }
            else { qText = q.def; ans = q.en; }

            document.getElementById('qDisplay').textContent = qText;
            
            let opts = [ans];
            let pool = db.filter(v => v.en !== q.en).map(v => {
                if(currentMode === 1) return v.fa;
                if(currentMode === 2) return v.en;
                if(currentMode === 3) return v.def;
                return v.en;
            });
            
            while(opts.length < 4 && pool.length) {
                let r = pool.splice(Math.floor(Math.random()*pool.length), 1)[0];
                if(!opts.includes(r)) opts.push(r);
            }
            opts.sort(() => 0.5 - Math.random());

            const div = document.getElementById('opts');
            div.innerHTML = '';
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'btn-opt';
                b.textContent = o;
                b.onclick = () => {
                    if(busy) return; busy = true;
                    if(o === ans) {
                        b.classList.add('correct');
                    } else {
                        b.classList.add('wrong');
                        if(!mistakeBank.some(m => m.en === q.en)) {
                            mistakeBank.push(q);
                            localStorage.setItem('fred_mistakes_v4', JSON.stringify(mistakeBank));
                        }
                        div.querySelectorAll('button').forEach(btn => { if(btn.textContent === ans) btn.classList.add('correct'); });
                    }
                    setTimeout(() => { 
                        idx++; 
                        if(idx < session.length) render(); 
                        else {
                            alert("ØªÙ…Ø±ÛŒÙ† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!");
                            location.reload();
                        }
                    }, 1500);
                };
                div.appendChild(b);
            });
            say(); 
        }

        function say() {
            if (!session[idx]) return;
            const q = session[idx];
            // Ø¯Ø± Ø­Ø§Ù„Øª "ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª" Ù…ØªÙ† ØªØ¹Ø±ÛŒÙ Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ø¯ØŒ Ø¯Ø± Ø¨Ù‚ÛŒÙ‡ Ø­Ø§Ù„Ø§Øª Ù„ØºØª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø±Ø§
            let textToSay = (currentMode === 4) ? q.def : q.en;
            
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(textToSay);
            u.lang = 'en-US';
            u.rate = 0.6; // Ø³Ø±Ø¹Øª Ø¨Ø³ÛŒØ§Ø± Ø´Ù…Ø±Ø¯Ù‡ (Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø³ØªØ§Ø¯)
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
