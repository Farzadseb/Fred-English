<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù„ØºØ§Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ - Ø³Ø·Ø­ A1">
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <title>English with Fred - A1 Pro</title>
    
    <style>
        :root { 
            --ios-blue: #4a90e2; --ios-green: #25D366; --ios-red: #FF3B30; --ios-indigo: #6c5ce7;
            --bg-page: #f0f7ff; --card-bg: rgba(255,255,255,0.95); --text-color: #2d3436;
            --radius: 20px; --shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        [data-theme="dark"] { --bg-page: #101418; --card-bg: rgba(45,52,54,0.98); --text-color: #f1f2f6; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg-page); color:var(--text-color); height:100vh; width:100%; position:fixed; overflow:hidden; padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom); }
        .screen { height:100%; display:flex; flex-direction:column; padding:20px; padding-top:calc(20px + env(safe-area-inset-top)); align-items:center; justify-content:space-between; }
        .header-nav { width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .header-title { font-size:24px; font-weight:900; color:var(--text-color); cursor:pointer; }
        .top-icon { font-size:22px; cursor:pointer; color:var(--text-color); width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:50%; }
        .top-icon:active { background:rgba(0,0,0,0.05); }
        .stars-box { background:var(--card-bg); width:90%; max-width:300px; border-radius:var(--radius); padding:15px; margin:10px 0; text-align:center; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.2); }
        .goal-stars { font-size:24px; color:#dfe6e9; letter-spacing:5px; }
        .goal-stars .active { color:#f1c40f; }
        .score-label { font-size:14px; font-weight:700; margin-top:8px; color:var(--text-color); }
        .mode-selector { width:90%; max-width:300px; margin:15px 0; }
        .btn-mode { background:var(--card-bg); padding:16px; margin:8px 0; border-radius:16px; text-align:center; font-weight:700; font-size:16px; color:var(--text-color); cursor:pointer; box-shadow:var(--shadow); border:2px solid transparent; transition:all 0.2s ease; }
        .btn-mode.active { border-color:var(--ios-blue); color:var(--ios-blue); background:rgba(74,144,226,0.1); }
        .btn-mode:active { transform:scale(0.98); }
        .btn-main { background:linear-gradient(145deg,var(--ios-blue),#3a7bc8); color:white; font-weight:800; width:90%; max-width:300px; padding:18px; border-radius:var(--radius); margin:10px 0; font-size:17px; cursor:pointer; border:none; box-shadow:0 10px 25px rgba(74,144,226,0.3); transition:all 0.2s ease; }
        .btn-main:nth-of-type(2) { background:linear-gradient(145deg,var(--ios-indigo),#5b4cd6); box-shadow:0 10px 25px rgba(108,92,231,0.3); }
        .btn-main.btn-exit { background:linear-gradient(145deg,#ff6b6b,#ee5a52); box-shadow:0 10px 25px rgba(255,107,107,0.3); }
        .btn-main:active { transform:scale(0.97); }
        .btn-main:disabled { opacity:0.5; cursor:not-allowed; }
        .footer-contact { width:90%; max-width:300px; margin-top:20px; padding-bottom:calc(20px + env(safe-area-inset-bottom)); }
        .whatsapp-btn { background:linear-gradient(145deg,var(--ios-green),#1da851); color:white; text-decoration:none; display:flex; align-items:center; justify-content:center; gap:12px; padding:16px; border-radius:50px; font-weight:bold; font-size:15px; box-shadow:0 8px 20px rgba(37,211,102,0.3); }
        #quizScreen { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-page); z-index:10; }
        .q-text { font-size:2.2rem; font-weight:900; text-align:center; color:var(--text-color); padding:40px 20px; line-height:1.4; }
        .options-grid { width:90%; max-width:400px; margin-top:20px; }
        .btn-opt { background:var(--card-bg); padding:20px; margin:10px 0; border-radius:18px; font-size:17px; font-weight:600; text-align:center; color:var(--text-color); cursor:pointer; border:2px solid transparent; box-shadow:var(--shadow); transition:all 0.2s ease; }
        .btn-opt:active { transform:scale(0.97); }
        #installPrompt { position:fixed; bottom:20px; left:20px; right:20px; background:var(--card-bg); border-radius:var(--radius); padding:15px; box-shadow:0 10px 40px rgba(0,0,0,0.2); display:none; z-index:1000; border:2px solid var(--ios-blue); }
        .install-content { display:flex; align-items:center; gap:15px; }
        .install-text { flex:1; }
        .install-title { font-weight:800; margin-bottom:5px; color:var(--text-color); }
        .install-desc { font-size:14px; opacity:0.8; color:var(--text-color); }
        .install-btn { background:var(--ios-blue); color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:700; cursor:pointer; }
        .close-install { background:none; border:none; font-size:20px; color:var(--text-color); cursor:pointer; opacity:0.7; }
        .pwa-badge { position:fixed; top:10px; right:10px; background:var(--ios-green); color:white; padding:5px 10px; border-radius:12px; font-size:12px; font-weight:700; display:none; z-index:1001; }
        .simple-modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:2000; padding:20px; }
        .simple-modal.show { display:flex; }
        .modal-content { background:var(--card-bg); border-radius:var(--radius); padding:25px; max-width:400px; width:90%; max-height:85vh; overflow-y:auto; -webkit-overflow-scrolling:touch; }
        .modal-title { font-size:20px; font-weight:900; margin-bottom:15px; color:var(--text-color); }
        .modal-message { margin-bottom:25px; line-height:1.6; color:var(--text-color); word-wrap:break-word; overflow-wrap:break-word; }
        .modal-buttons { display:flex; gap:10px; flex-direction:column; }
        .modal-btn { padding:14px; border-radius:14px; font-weight:700; border:none; cursor:pointer; min-height:44px; }
        .modal-btn-primary { background:var(--ios-blue); color:white; }
        .modal-btn-secondary { background:rgba(0,0,0,0.08); color:var(--text-color); }
        .user-welcome { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(10px); display:none; align-items:center; justify-content:center; z-index:9999; padding:20px; animation:fadeIn 0.4s ease; }
        .welcome-content { background:linear-gradient(145deg,var(--ios-blue),#3a7bc8); color:white; border-radius:25px; padding:35px 25px; text-align:center; max-width:400px; width:90%; box-shadow:0 25px 60px rgba(0,0,0,0.4); animation:slideUp 0.5s ease 0.2s both; border:2px solid rgba(255,255,255,0.2); }
        .welcome-icon { font-size:70px; margin-bottom:20px; animation:bounce 1s infinite alternate; }
        @keyframes bounce { from { transform:translateY(0); } to { transform:translateY(-10px); } }
        .welcome-text { font-size:22px; font-weight:900; margin-bottom:20px; line-height:1.5; }
        .welcome-subtext { font-size:16px; opacity:0.9; margin-bottom:30px; line-height:1.6; }
        .welcome-btn { background:white; color:var(--ios-blue); border:none; padding:16px 30px; border-radius:16px; font-weight:900; font-size:17px; cursor:pointer; width:100%; transition:all 0.2s; box-shadow:0 8px 25px rgba(255,255,255,0.2); }
        .welcome-btn:active { transform:scale(0.96); }
        .user-badge { position:fixed; top:20px; left:20px; background:var(--card-bg); padding:10px 16px; border-radius:50px; font-size:14px; font-weight:700; display:flex; align-items:center; gap:10px; cursor:pointer; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.2); z-index:100; transition:all 0.3s; backdrop-filter:blur(10px); }
        .user-badge:hover { transform:translateY(-2px); box-shadow:0 15px 35px rgba(0,0,0,0.15); }
        .user-badge.guest { background:linear-gradient(145deg,#f8f9fa,#e9ecef); color:#495057; }
        .user-badge.returning { background:linear-gradient(145deg,var(--ios-green),#1da851); color:white; }
        .badge-icon { font-size:20px; }
        .badge-text { font-size:15px; }
        @media (max-height:700px) { .q-text { font-size:1.8rem; padding:20px; } .btn-main, .btn-mode { padding:14px; } }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes slideUp { from { transform:translateY(50px) scale(0.9); opacity:0; } to { transform:translateY(0) scale(1); opacity:1; } }
    </style>
</head>
<body id="mainBody">
    <div id="pwaBadge" class="pwa-badge">ğŸ“± Ù†ØµØ¨ Ø´Ø¯Ù‡</div>
    <div id="installPrompt"><div class="install-content"><div class="install-text"><div class="install-title">ğŸ“± Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡</div><div class="install-desc">Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ±ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯</div></div><button id="installBtn" class="install-btn">Ù†ØµØ¨</button><button id="closeInstall" class="close-install">âœ•</button></div></div>
    <div id="userWelcome" class="user-welcome"><div class="welcome-content"><div class="welcome-icon">ğŸ‰</div><div class="welcome-text">Ø¨Ù‡ English with Fred Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</div><div class="welcome-subtext">ğŸ¯ Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ø§Ù‡ Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù„ØºØ§Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ<br>ğŸ“± Ù‚Ø§Ø¨Ù„ Ù†ØµØ¨ Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ<br>ğŸ“š Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª<br>ğŸ’¾ Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div><button onclick="hideWelcome()" class="welcome-btn">Ø´Ø±ÙˆØ¹ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ! ğŸš€</button></div></div>
    <div id="userBadge" class="user-badge guest" onclick="showUserStats()"><span class="badge-icon">ğŸ‘¤</span><span class="badge-text">Ù…Ù‡Ù…Ø§Ù†</span></div>
    <div id="simpleModal" class="simple-modal"><div class="modal-content"><div id="modalTitle" class="modal-title"></div><div id="modalMessage" class="modal-message"></div><div id="modalButtons" class="modal-buttons"></div></div></div>
    <div id="setup" class="screen">
        <div class="header-nav"><div class="top-icon" onclick="toggleTheme()">ğŸŒ“</div><h1 class="header-title" onclick="showVersion()">English with Fred</h1><div id="muteBtn" class="top-icon" onclick="toggleMute()">ğŸ”Š</div></div>
        <div class="stars-box"><div id="goalStars" class="goal-stars">â˜†â˜†â˜†â˜†</div><div class="score-label">Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: <span id="highScore">0</span>%</div></div>
        <div class="mode-selector"><div class="btn-mode active" onclick="setMode(1, this)">Û±. Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ</div><div class="btn-mode" onclick="setMode(2, this)">Û². ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</div><div class="btn-mode" onclick="setMode(3, this)">Û³. Ù„ØºØª Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ</div><div class="btn-mode" onclick="setMode(4, this)">Û´. ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª</div></div>
        <button class="btn-main" onclick="startQuiz(false)">ğŸš€ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯</button>
        <button class="btn-main" onclick="startQuiz(true)" id="reviewBtn">ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª (0)</button>
        <button class="btn-main btn-exit" onclick="showExitModal()">ğŸšª Ø®Ø±ÙˆØ¬</button>
        <div class="footer-contact"><a href="https://wa.me/989017708544" class="whatsapp-btn"><i class="fab fa-whatsapp"></i><span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: 09017708544</span></a></div>
    </div>
    <div id="quizScreen" class="screen">
        <div class="header-nav"><div class="top-icon" onclick="speakCurrent()">ğŸ”Š</div><div id="progress" style="font-weight:900;font-size:18px;color:var(--text-color);">1/<span id="totalQuestions">20</span></div><div class="top-icon" onclick="showExitQuizModal()">âœ•</div></div>
        <div id="qDisplay" class="q-text"></div><div class="options-grid" id="opts"></div>
    </div>
    <script>
        const APP_VERSION = '1.0.0';
        let db = [], session = [], idx = 0, currentMode = 1, isMuted = false, correctCount = 0;
        let mistakes = [], currentQuestionCount = 20, deferredPrompt = null, activeModal = null;
        
        function initUserSystem() {
            const hasVisitedBefore = localStorage.getItem('fred_has_visited');
            if (!hasVisitedBefore) {
                setupNewUser();
                setTimeout(showWelcomeMessage, 1500);
            } else {
                const visitCount = parseInt(localStorage.getItem('fred_visit_count') || 0) + 1;
                localStorage.setItem('fred_visit_count', visitCount);
                if (visitCount >= 3) updateUserBadge('returning');
                if (visitCount === 3 && !localStorage.getItem('fred_pwa_suggested')) {
                    setTimeout(() => { showPWAInstallSuggestion(); }, 3000);
                }
            }
        }
        function setupNewUser() {
            localStorage.setItem('fred_user_id', 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2,9));
            localStorage.setItem('fred_user_type', 'guest');
            localStorage.setItem('fred_has_visited', 'true');
            localStorage.setItem('fred_first_visit', new Date().toISOString());
            localStorage.setItem('fred_visit_count', '1');
        }
        function showWelcomeMessage() {
            document.getElementById('userWelcome').style.display = 'flex';
        }
        function hideWelcome() {
            document.getElementById('userWelcome').style.display = 'none';
        }
        function updateUserBadge(type='guest') {
            const badge = document.getElementById('userBadge');
            const badgeIcon = badge.querySelector('.badge-icon');
            const badgeText = badge.querySelector('.badge-text');
            badge.className = `user-badge ${type}`;
            if (type === 'returning') { badgeIcon.textContent = 'ğŸ‘¨â€ğŸ“'; badgeText.textContent = 'Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„'; }
            else { badgeIcon.textContent = 'ğŸ‘¤'; badgeText.textContent = 'Ù…Ù‡Ù…Ø§Ù†'; }
        }
        function showUserStats() {
            const visitCount = localStorage.getItem('fred_visit_count') || '1';
            const firstVisit = localStorage.getItem('fred_first_visit');
            const firstVisitDate = firstVisit ? new Date(firstVisit).toLocaleDateString('fa-IR') : 'Ø§Ù…Ø±ÙˆØ²';
            showModal('ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±ÛŒ', `ğŸ‘¤ ÙˆØ¶Ø¹ÛŒØª: ${visitCount >= 3 ? 'Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„' : 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†'}\n\nğŸ“… Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø²Ø¯ÛŒØ¯: ${firstVisitDate}\nğŸ”„ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²Ø¯ÛŒØ¯Ù‡Ø§: ${visitCount}\nğŸ† Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: ${localStorage.getItem('fred_best')||0}%\nğŸ“– Ù„ØºØ§Øª Ø¢Ù…ÙˆØ®ØªÙ‡: ${db.length}\n\nğŸ’¾ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.`, [{text:'Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…',action:'close'}]);
        }
        function showPWAInstallSuggestion() {
            showModal('ğŸ’¡ Ù†Ú©ØªÙ‡ Ù…ÙÛŒØ¯', 'Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒØ§Ø¯ Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø®ÙˆØ´Øª Ù…ÛŒØ§Ø¯!\n\nÙ…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÙˆÙ† Ø±Ùˆ Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù†ØµØ¨ Ú©Ù†ÛŒ:\nğŸ“± Ø¯Ø± Ù…Ù†ÙˆÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± â†’ Add to Home Screen\n\nØ§ÛŒÙ†Ø·ÙˆØ±ÛŒ:\nâœ… Ù…Ø«Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡\nâœ… Ø¢ÙÙ„Ø§ÛŒÙ† Ù‡Ù… Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡\nâœ… Ø¢ÛŒÚ©ÙˆÙ† Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¯Ø§Ø±Ù‡', [{text:'Ø¨Ø§Ø´Ù‡ Ù…Ù…Ù†ÙˆÙ†!',action:'close'}]);
            localStorage.setItem('fred_pwa_suggested', 'true');
        }
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            document.getElementById('pwaBadge').style.display = 'block';
        }
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            if (!localStorage.getItem('fred_install_hidden')) {
                setTimeout(() => { document.getElementById('installPrompt').style.display = 'block'; }, 2000);
            }
        });
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) return; deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null;
            document.getElementById('installPrompt').style.display = 'none';
        });
        document.getElementById('closeInstall').addEventListener('click', () => {
            document.getElementById('installPrompt').style.display = 'none';
            localStorage.setItem('fred_install_hidden', 'true');
        });
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showModal('ğŸ”„ Ø¢Ù¾Ø¯ÛŒØª Ø¬Ø¯ÛŒØ¯', 'Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!', [{text:'Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†',action:()=>window.location.reload()},{text:'Ø¨Ø¹Ø¯Ø§Ù‹',action:'close',type:'secondary'}]);
                            }
                        });
                    });
                });
            });
        }
        function showModal(title, message, buttons) {
            if (activeModal) hideModal();
            const modal = document.getElementById('simpleModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `modal-btn modal-btn-${btn.type||'primary'}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    hideModal();
                    if (typeof btn.action === 'function') setTimeout(() => btn.action(), 100);
                };
                modalButtons.appendChild(button);
            });
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            activeModal = modal;
        }
        function hideModal() {
            if (activeModal) { activeModal.classList.remove('show'); activeModal = null; }
            document.body.style.overflow = '';
        }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && activeModal) hideModal();
        });
        document.getElementById('simpleModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('simple-modal')) hideModal();
        });
        window.onload = function() {
            console.log(`ğŸš€ English with Fred v${APP_VERSION}`);
            try {
                const best = localStorage.getItem('fred_best') || 0;
                document.getElementById('highScore').textContent = best;
                updateStars(best);
                loadMistakes();
                currentQuestionCount = getAdaptiveQuestionCount();
                document.getElementById('totalQuestions').textContent = currentQuestionCount;
                db = processRawWords(rawWords);
                console.log(`ğŸ“– Loaded ${db.length} words`);
                const savedTheme = localStorage.getItem('fred_theme');
                if (savedTheme === 'dark') document.getElementById('mainBody').setAttribute('data-theme', 'dark');
                updateReviewButton();
                setTimeout(initUserSystem, 500);
            } catch (error) {
                console.error("âŒ Loading error:", error);
                showModal('Ø®Ø·Ø§', 'Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.', [{text:'Ø±ÙØ±Ø´',action:()=>location.reload()}]);
            }
        };
        function normalizeText(text) {
            return text.toString().trim().replace(/\s+/g,' ').replace(/[Ù«Ù¬]/g,',').replace(/[ÙŠÙ‰]/g,'ÛŒ').replace(/[Ùƒ]/g,'Ú©').toLowerCase();
        }
        function isAnswerCorrect(userAnswer, correctAnswer, mode) {
            const user = normalizeText(userAnswer), correct = normalizeText(correctAnswer);
            if (user === correct) return true;
            if (mode === 1 || mode === 3) {
                const removeArticles = (str) => str.replace(/^(a|an|the)\s+/i,'').trim();
                if (removeArticles(user) === removeArticles(correct)) return true;
            }
            if (mode === 2) {
                const removePrefixes = (str) => str.replace(/^(Ù…ÛŒ|Ù†Ù…ÛŒ)\s*/g,'').trim();
                if (removePrefixes(user) === removePrefixes(correct)) return true;
            }
            return false;
        }
        function processRawWords(rawText) {
            return rawText.split('\n').filter(line=>line.trim()).map(line=>{
                const parts = line.split(' â€” ');
                return { en:parts[0]?.trim()||'', fa:parts[1]?.trim()||'', def:parts[2]?.trim()||'Ø¨Ø¯ÙˆÙ† ØªØ¹Ø±ÛŒÙ', example:parts[3]?.trim()||'Ø¨Ø¯ÙˆÙ† Ù…Ø«Ø§Ù„' };
            }).filter(word=>word.en&&word.fa);
        }
        function getAdaptiveQuestionCount() {
            const best = parseInt(localStorage.getItem('fred_best')||0);
            const saved = parseInt(localStorage.getItem('fred_question_count'));
            if (saved && saved >= 10 && saved <= 30) return saved;
            if (best < 50) return 10;
            if (best < 80) return 15;
            return 20;
        }
        function loadMistakes() {
            try { mistakes = localStorage.getItem('fred_mistakes') ? JSON.parse(localStorage.getItem('fred_mistakes')) : []; }
            catch (error) { mistakes = []; }
        }
        function saveMistakes() {
            localStorage.setItem('fred_mistakes', JSON.stringify(mistakes));
            updateReviewButton();
        }
        function updateReviewButton() {
            const btn = document.getElementById('reviewBtn');
            if (mistakes.length > 0) { btn.textContent = `ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª (${mistakes.length})`; btn.disabled = false; }
            else { btn.textContent = 'ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª (Ù‡ÛŒÚ†ÛŒ)'; btn.disabled = true; }
        }
        function updateStars(score) {
            let starHTML = "", active = Math.floor(score / 25);
            for(let i=1;i<=4;i++) starHTML += (i <= active) ? "<span class='active'>â˜…</span>" : "â˜†";
            document.getElementById('goalStars').innerHTML = starHTML;
        }
        function updateMistakeStats(word, isCorrect) {
            const existing = mistakes.find(m => normalizeText(m.en) === normalizeText(word.en));
            if (existing) {
                if (isCorrect) { existing.correctAttempts = (existing.correctAttempts||0)+1; if (existing.correctAttempts >= 3) mistakes = mistakes.filter(m => normalizeText(m.en) !== normalizeText(word.en)); }
                else { existing.correctAttempts = 0; }
                existing.lastSeen = Date.now();
            } else if (!isCorrect) {
                mistakes.push({ en:word.en, fa:word.fa, def:word.def, example:word.example, correctAttempts:0, lastSeen:Date.now(), added:Date.now() });
            }
            saveMistakes();
        }
        function generateOptions(correctAnswer, allWords, mode) {
            let options = [correctAnswer], used = new Set([normalizeText(correctAnswer)]);
            const getOption = (word) => { if (mode===1) return word.fa; if (mode===2) return word.en; if (mode===3) return word.def; return word.en; };
            let pool = [...allWords].filter(w => !used.has(normalizeText(getOption(w))));
            while (options.length < 4 && pool.length > 0) {
                const randomIndex = Math.floor(Math.random()*pool.length);
                const word = pool[randomIndex], option = getOption(word);
                if (!used.has(normalizeText(option))) { options.push(option); used.add(normalizeText(option)); }
                pool.splice(randomIndex,1);
            }
            while (options.length < 4) { options.push(correctAnswer + " (ØªÚ©Ø±Ø§Ø±ÛŒ)"); }
            return options.sort(() => Math.random() - 0.5);
        }
        function toggleTheme() {
            const body = document.getElementById('mainBody');
            if (body.hasAttribute('data-theme')) { body.removeAttribute('data-theme'); localStorage.setItem('fred_theme','light'); }
            else { body.setAttribute('data-theme','dark'); localStorage.setItem('fred_theme','dark'); }
        }
        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
        }
        function setMode(m, el) {
            currentMode = m;
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
        function showVersion() {
            const stats = { version:APP_VERSION, words:db.length, mistakes:mistakes.length, best:localStorage.getItem('fred_best')||0, sessions:localStorage.getItem('fred_sessions')||0 };
            showModal('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡', `ğŸ“± English with Fred v${stats.version}\n\nğŸ“– Ù„ØºØ§Øª: ${stats.words}\nğŸ”´ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª ÙØ¹Ø§Ù„: ${stats.mistakes}\nğŸ† Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: ${stats.best}%\nğŸ“… ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡: ${stats.sessions}\n\nÂ© Fred - PDCS A1`, [{text:'Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…',action:'close'}]);
        }
        function showExitModal() {
            showModal('Ø®Ø±ÙˆØ¬', 'Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ', [
                {text:'Ø®ÛŒØ±',action:'close',type:'secondary'},
                {text:'Ø¨Ù„Ù‡',action:()=>{
                    if (window.navigator.standalone) showModal('Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø®Ø±ÙˆØ¬','Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬:\n\nğŸ“± iOS: Ø¯Ú©Ù…Ù‡ Home Ø±Ø§ Ø¯Ùˆ Ø¨Ø§Ø± Ø¨Ø²Ù†ÛŒØ¯\nğŸ¤– Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯: Ø¯Ú©Ù…Ù‡ Recent Apps',[{text:'Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…',action:'close'}]);
                    else window.close();
                }}
            ]);
        }
        function showExitQuizModal() {
            showModal('Ø®Ø±ÙˆØ¬ Ø§Ø² ØªÙ…Ø±ÛŒÙ†', 'Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² ØªÙ…Ø±ÛŒÙ† Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ Ù¾ÛŒØ´Ø±ÙØª ÙØ¹Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.', [
                {text:'Ø¨Ø§Ø²Ú¯Ø´Øª',action:'close',type:'secondary'},
                {text:'Ø®Ø±ÙˆØ¬',action:()=>location.reload()}
            ]);
        }
        function startQuiz(onlyMistakes) {
            if (onlyMistakes && mistakes.length === 0) {
                showModal('Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ¨Ø§Ù‡', 'Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!', [{text:'Ø¨Ø§Ø´Ù‡',action:'close'}]);
                return;
            }
            if (onlyMistakes) session = [...mistakes].sort(()=>Math.random()-0.5).slice(0,Math.min(15,mistakes.length));
            else session = [...db].sort(()=>Math.random()-0.5).slice(0,currentQuestionCount);
            if (session.length < 4) {
                showModal('Ø®Ø·Ø§', 'Ù„ØºØ§Øª Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!', [{text:'Ø¨Ø§Ø´Ù‡',action:'close'}]);
                return;
            }
            idx = 0; correctCount = 0;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'flex';
            renderQuestion();
        }
        function renderQuestion() {
            if (idx >= session.length) { finishQuiz(); return; }
            const q = session[idx];
            document.getElementById('progress').textContent = `${idx + 1}/${session.length}`;
            let qText = "", ans = "";
            if(currentMode===1){qText=q.en;ans=q.fa;}
            else if(currentMode===2){qText=q.fa;ans=q.en;}
            else if(currentMode===3){qText=q.en;ans=q.def;}
            else{qText=q.def;ans=q.en;}
            document.getElementById('qDisplay').textContent = qText;
            const div = document.getElementById('opts'); div.innerHTML = '';
            const options = generateOptions(ans, db, currentMode);
            options.forEach(option => {
                const btn = document.createElement('button'); btn.className='btn-opt'; btn.textContent=option;
                btn.onclick = function() {
                    const isCorrect = isAnswerCorrect(option, ans, currentMode);
                    document.querySelectorAll('.btn-opt').forEach(b => {
                        b.style.pointerEvents='none';
                        if (normalizeText(b.textContent)===normalizeText(ans)) {
                            b.style.background="linear-gradient(145deg,var(--ios-green),#1da851)";
                            b.style.color="white"; b.style.boxShadow="0 0 0 3px rgba(37,211,102,0.3)";
                        }
                    });
                    if (isCorrect) {
                        btn.style.background="linear-gradient(145deg,var(--ios-green),#1da851)";
                        btn.style.color="white"; correctCount++; updateMistakeStats(q,true);
                    } else {
                        btn.style.background="linear-gradient(145deg,var(--ios-red),#e02b20)";
                        btn.style.color="white"; updateMistakeStats(q,false);
                    }
                    setTimeout(() => { showQuestionFeedback(isCorrect,option,ans,q); }, 1000);
                };
                div.appendChild(btn);
            });
            speakCurrent();
        }
        function showQuestionFeedback(isCorrect, userAnswer, correctAnswer, word) {
            let message = isCorrect ? `âœ… Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ ØµØ­ÛŒØ­ Ø§Ø³Øª!\n\n` : `âŒ Ù¾Ø§Ø³Ø® Ø´Ù…Ø§: ${userAnswer}\nâœ… Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­: ${correctAnswer}\n\n`;
            message += `ğŸ“– Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ: ${word.en}\nğŸ“š ÙØ§Ø±Ø³ÛŒ: ${word.fa}\n`;
            if (word.def !== 'Ø¨Ø¯ÙˆÙ† ØªØ¹Ø±ÛŒÙ') message += `ğŸ“ ØªØ¹Ø±ÛŒÙ: ${word.def}\n`;
            if (word.example !== 'Ø¨Ø¯ÙˆÙ† Ù…Ø«Ø§Ù„') message += `ğŸ’¡ Ù…Ø«Ø§Ù„: ${word.example}`;
            showModal(isCorrect?'Ø¢ÙØ±ÛŒÙ†! ğŸ‰':'Ø¨ÛŒØ§ÛŒÛŒØ¯ ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±ÛŒÙ… ğŸ“š', message, [{text:'Ø§Ø¯Ø§Ù…Ù‡',action:()=>{idx++;renderQuestion();}}]);
        }
        function finishQuiz() {
            const score = Math.round((correctCount/session.length)*100);
            const best = parseInt(localStorage.getItem('fred_best')||0);
            if (score > best) { localStorage.setItem('fred_best',score); updateStars(score); }
            const sessions = parseInt(localStorage.getItem('fred_sessions')||0)+1;
            localStorage.setItem('fred_sessions',sessions);
            let message = `ğŸ‰ ØªÙ…Ø±ÛŒÙ† ØªÙ…Ø§Ù… Ø´Ø¯!\n\nğŸ† Ø§Ù…ØªÛŒØ§Ø²: ${score}%\nâœ… ØµØ­ÛŒØ­: ${correctCount} Ø§Ø² ${session.length}\n\n`;
            if (score > best) message += `ğŸŠ Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯!\n\n`;
            if (mistakes.length > 0) message += `ğŸ”´ ${mistakes.length} Ù„ØºØª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø±ÙˆØ± Ø¯Ø§Ø±Ù†Ø¯\n(Ø¯Ø± Ø¨Ø®Ø´ "Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª" Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù‡Ø³ØªÙ†Ø¯)`;
            else message += `âœ¨ Ø¹Ø§Ù„ÛŒ! ØªÙ…Ø§Ù… Ù„ØºØ§Øª Ø±Ø§ ÛŒØ§Ø¯ Ú¯Ø±ÙØªÙ‡â€ŒØ§ÛŒ!`;
            showModal('Ù†ØªÛŒØ¬Ù‡ ØªÙ…Ø±ÛŒÙ†', message, [
                {text:'ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯',action:()=>{document.getElementById('quizScreen').style.display='none';document.getElementById('setup').style.display='flex';hideModal();}},
                {text:'Ø®Ø±ÙˆØ¬',action:()=>location.reload(),type:'secondary'}
            ]);
        }
        function speakCurrent() {
            if (isMuted || idx >= session.length) return;
            const q = session[idx];
            let text = "", lang = "en-US";
            if (currentMode===1||currentMode===3) { text=q.en; lang="en-US"; }
            else if (currentMode===2) { text=q.fa; lang="fa-IR"; }
            else { text=q.def; lang=/[\u0600-\u06FF]/.test(q.def)?"fa-IR":"en-US"; }
            speakText(text,lang);
        }
        function speakText(text,lang) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang; utterance.rate = 0.9; utterance.volume = 1;
            utterance.onerror = function(event) {
                console.warn(`Speech error for ${lang}:`,event.error);
                if (lang==='fa-IR' && lang!=='en-US') {
                    setTimeout(()=>{
                        const fallbackUtterance=new SpeechSynthesisUtterance(text);
                        fallbackUtterance.lang='en-US'; fallbackUtterance.rate=0.95;
                        window.speechSynthesis.speak(fallbackUtterance);
                    },300);
                }
            };
            utterance.onstart=function(){console.log(`âœ… Speaking: ${text.substring(0,30)}...`);};
            utterance.onend=function(){console.log('âœ… Speech finished');};
            const voices=window.speechSynthesis.getVoices();
            const hasLanguage=voices.some(voice=>voice.lang===lang||voice.lang.startsWith(lang.split('-')[0]));
            if (!hasLanguage && lang==='fa-IR') { console.log('âš ï¸ Persian not supported, using English'); utterance.lang='en-US'; }
            window.speechSynthesis.speak(utterance);
        }
        window.addEventListener('online',()=>{document.body.style.borderTop='3px solid var(--ios-green)';setTimeout(()=>{document.body.style.borderTop='none';},2000);});
        window.addEventListener('offline',()=>{document.body.style.borderTop='3px solid var(--ios-red)';});
        document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&document.getElementById('quizScreen').style.display==='flex')showExitQuizModal();});
        document.addEventListener('contextmenu',(e)=>e.preventDefault());
        console.log("âœ… App initialized successfully!");
    </script>
</body>
</html>
