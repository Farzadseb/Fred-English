<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>English with Fred Elite</title>
    <style>
        :root {
            --bg-grad: linear-gradient(135deg, #eef2f3 0%, #8e9eab 100%);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.4);
            --text-main: #2d3436;
            --primary-blue: #5da2d5; 
            --soft-indigo: #7085b8;
        }

        [data-theme="dark"] {
            --bg-grad: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            --glass-bg: rgba(45, 52, 54, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f1f2f6;
            --primary-blue: #4a90e2;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: all 0.3s ease; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-grad);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .screen {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            width: 100%;
            max-width: 420px;
            border-radius: 35px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .header-nav {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-controls { display: flex; gap: 12px; }

        .nav-btn {
            background: rgba(0,0,0,0.05);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-main);
        }

        .icon-btn {
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        .header-title { font-size: 22px; font-weight: 800; color: var(--text-main); margin: 0; }

        .btn-mode {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 18px; width: 100%; margin-bottom: 10px;
            font-weight: 600; cursor: pointer; color: var(--text-main); font-size: 15px;
        }

        .btn-mode.active { 
            background: var(--primary-blue); 
            color: white; 
            border: none; 
            box-shadow: 0 5px 15px rgba(93,162,213,0.3); 
        }

        .q-container { width: 100%; min-height: 100px; display: flex; justify-content: center; align-items: center; margin: 15px 0; }
        .q-text { font-size: 1.5rem; font-weight: 700; text-align: center; direction: ltr; color: var(--text-main); }

        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; width: 100%; }
        .btn-opt { 
            padding: 16px; border-radius: 20px; border: 1px solid var(--glass-border); 
            background: rgba(255, 255, 255, 0.5); font-size: 16px; font-weight: 600; 
            cursor: pointer; color: var(--text-main); 
        }

        .btn-action { 
            border: none; color: white; font-weight: 700; width: 100%; padding: 18px; 
            border-radius: 22px; margin-top: 10px; font-size: 17px; cursor: pointer; 
            background: var(--primary-blue); 
        }

        .correct { background: #55efc4 !important; color: #00b894 !important; border: none; }
        .wrong { background: #ff7675 !important; color: white !important; border: none; }
    </style>
</head>
<body>

    <div id="setup" class="screen">
        <div class="header-nav">
            <div class="nav-controls">
                <div class="icon-btn" onclick="toggleTheme()" title="ØªØºÛŒÛŒØ± ØªÙ…">ğŸŒ“</div>
                <div id="mainMuteBtn" class="icon-btn" onclick="toggleMute()" title="Ù‚Ø·Ø¹/ÙˆØµÙ„ ØµØ¯Ø§">ğŸ”Š</div>
            </div>
            <h1 class="header-title">Fred English</h1>
            <div style="width:40px"></div>
        </div>
        
        <div style="width: 100%; margin-bottom: 20px;">
            <div class="btn-mode active" onclick="setMode(1, this)">Û±. Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(2, this)">Û². ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</div>
            <div class="btn-mode" onclick="setMode(3, this)">Û³. Ù„ØºØª Ø¨Ù‡ ØªØ¹Ø±ÛŒÙ</div>
            <div class="btn-mode" onclick="setMode(4, this)">Û´. ØªØ¹Ø±ÛŒÙ Ø¨Ù‡ Ù„ØºØª</div>
        </div>
        
        <button class="btn-action" onclick="startQuiz(false)">ğŸš€ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯</button>
        <button class="btn-action" style="background: var(--soft-indigo); opacity: 0.9;" onclick="startQuiz(true)">ğŸ¯ Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª</button>
    </div>

    <div id="quiz" class="screen" style="display: none;">
        <div class="header-nav">
            <button class="nav-btn" onclick="say()" title="ØªÚ©Ø±Ø§Ø± ØªÙ„ÙØ¸">ğŸ”Š</button>
            <div style="font-weight: bold; color: var(--text-main); font-size: 13px; opacity: 0.6;" id="progressText">1 / 20</div>
            <button class="nav-btn" onclick="location.reload()" title="Ø®Ø±ÙˆØ¬">âœ•</button>
        </div>

        <div class="q-container">
            <div id="qDisplay" class="q-text"></div>
        </div>

        <div id="opts" class="options-grid"></div>
    </div>

    <script src="dic.js"></script>

    <script>
        let db = [], session = [], idx = 0, currentMode = 1, busy = false;
        let isMuted = false;
        let mistakeBank = JSON.parse(localStorage.getItem('fred_mistakes_v4')) || [];

        function toggleTheme() {
            const body = document.body;
            body.getAttribute('data-theme') === 'dark' ? body.removeAttribute('data-theme') : body.setAttribute('data-theme', 'dark');
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('mainMuteBtn').textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
            if(isMuted) window.speechSynthesis.cancel();
        }

        function setMode(m, el) { 
            currentMode = m; 
            document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active')); 
            el.classList.add('active'); 
        }

        function startQuiz(fromMistakes) {
            let source = fromMistakes ? mistakeBank : (typeof permanentWords !== 'undefined' ? permanentWords.trim().split('\n') : []);
            if(fromMistakes && mistakeBank.length === 0) return alert("Ù„ÛŒØ³Øª Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!");

            db = source.map(l => {
                let p = l.split(' â€” ');
                return p.length >= 2 ? { en: p[0].trim(), fa: p[1].trim(), def: p[2] ? p[2].trim() : "Def" } : null;
            }).filter(x => x);

            session = [...db].sort(() => 0.5 - Math.random());
            if(!fromMistakes) session = session.slice(0, 20); 
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('quiz').style.display = 'flex';
            idx = 0; render();
        }

        function render() {
            busy = false; const q = session[idx]; let qText = "", ans = "";
            document.getElementById('progressText').textContent = `${idx + 1} / ${session.length}`;

            if(currentMode === 1) { qText = q.en; ans = q.fa; }
            else if(currentMode === 2) { qText = q.fa; ans = q.en; }
            else if(currentMode === 3) { qText = q.en; ans = q.def; }
            else { qText = q.def; ans = q.en; }

            document.getElementById('qDisplay').textContent = qText;
            
            let opts = [ans];
            let pool = db.filter(v => v.en !== q.en).map(v => {
                if(currentMode === 1) return v.fa; if(currentMode === 2) return v.en;
                if(currentMode === 3) return v.def; return v.en;
            });
            while(opts.length < 4 && pool.length) {
                let r = pool.splice(Math.floor(Math.random()*pool.length), 1)[0];
                if(!opts.includes(r)) opts.push(r);
            }
            opts.sort(() => 0.5 - Math.random());

            const div = document.getElementById('opts');
            div.innerHTML = '';
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'btn-opt'; b.textContent = o;
                b.onclick = () => {
                    if(busy) return; busy = true;
                    if(o === ans) b.classList.add('correct');
                    else {
                        b.classList.add('wrong');
                        if(!mistakeBank.some(m => m.en === q.en)) {
                            mistakeBank.push(q);
                            localStorage.setItem('fred_mistakes_v4', JSON.stringify(mistakeBank));
                        }
                        div.querySelectorAll('button').forEach(btn => { if(btn.textContent === ans) btn.classList.add('correct'); });
                    }
                    setTimeout(() => { idx++; if(idx < session.length) render(); else location.reload(); }, 1500);
                };
                div.appendChild(b);
            });
            say(); 
        }

        function say() {
            if (!session[idx] || isMuted) return;
            let textToSay = (currentMode === 4) ? session[idx].def : session[idx].en;
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(textToSay);
            u.lang = 'en-US'; u.rate = 0.6;
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
